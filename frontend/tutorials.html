<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MyAutoSound Tutorials</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; }
    /* Lite YouTube embed */
    .yt-lite {
      position: relative; cursor: pointer; border-radius: 0.75rem;
      overflow: hidden; display: block; background-size: cover;
      background-position: center; min-height: 180px;
    }
    .yt-lite::after {
      content: "‚ñ∂";
      position: absolute; inset: 0; display: grid; place-items: center;
      font-size: 48px; background: rgba(0,0,0,.35); color: #fff;
    }
    /* Favorite star button base (color toggled in JS) */
    .fav-btn { transition: transform .15s ease; }
    .fav-btn:hover { transform: scale(1.1); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold text-blue-700">MyAutoSound Tutorials</h1>
      <a href="index.html" class="text-sm text-blue-600 hover:underline">‚Üê Back to Home</a>
    </div>
  </header>

  <!-- Filters -->
  <section class="max-w-5xl mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
      <input type="text" id="searchInput" placeholder="Search tutorials..." class="w-full md:w-1/3 p-3 rounded border border-gray-300" />

      <select id="categoryFilter" class="w-full md:w-1/3 p-3 rounded border border-gray-300">
        <option value="">All Categories</option>
        <option value="brake">Brake</option>
        <option value="engine">Engine</option>
        <option value="suspension">Suspension</option>
        <option value="steering">Steering</option>
        <option value="transmission">Transmission</option>
        <option value="exhaust">Exhaust</option>
        <option value="vacuum">Vacuum</option>
        <option value="drivetrain">Drivetrain</option>
      </select>

      <select id="typeFilter" class="w-full md:w-1/3 p-3 rounded border border-gray-300">
        <option value="">All Types</option>
        <option value="video">Video</option>
        <option value="audio">Audio</option>
        <option value="pdf">PDF</option>
      </select>
    </div>

    <!-- ‚≠ê Favorites -->
    <div id="favoritesWrap" class="mt-10 hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-yellow-700">‚≠ê Favorites <span id="favCount" class="text-sm text-gray-500 font-normal"></span></h2>
        <button id="clearFavs" class="text-sm text-red-600 hover:underline">Clear all</button>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="favoritesSection"></div>
    </div>

    <!-- üé• Video Tutorials -->
    <h2 class="text-2xl font-bold text-blue-800 mt-12 mb-6">üé• Video Tutorials</h2>

    <!-- üîß Fix it at home -->
    <h3 class="text-xl font-bold text-blue-700 mt-8 mb-4">üîß Fix it at home</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="videoFix"></div>
    <div class="flex justify-center mt-4">
      <button id="more-vfix" class="px-4 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300">Load more</button>
    </div>

    <!-- üëÇ Inspect your car noise -->
    <h3 class="text-xl font-bold text-blue-700 mt-8 mb-4">üëÇ Inspect your car noise</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="videoInspect"></div>
    <div class="flex justify-center mt-4">
      <button id="more-vins" class="px-4 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300">Load more</button>
    </div>

    <!-- üßº Car maintenance you should do at home -->
    <h3 class="text-xl font-bold text-blue-700 mt-8 mb-4">üßº Car maintenance you should do at home</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="videoMaintenance"></div>
    <div class="flex justify-center mt-4">
      <button id="more-vmaint" class="px-4 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300">Load more</button>
    </div>

    <!-- üîâ Audio Examples -->
    <h2 class="text-2xl font-bold text-blue-800 mt-12 mb-6">üîâ Sound Examples</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="audioSection"></div>
    <div class="flex justify-center mt-4">
      <button id="more-audio" class="px-4 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300">Load more</button>
    </div>

    <!-- üìÑ PDF Guides -->
    <h2 class="text-2xl font-bold text-blue-800 mt-12 mb-6">üìÑ PDF Guides</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="pdfSection"></div>
    <div class="flex justify-center mt-4">
      <button id="more-pdf" class="px-4 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300">Load more</button>
    </div>

    <!-- Status / errors -->
    <div id="statusMsg" class="mt-8 text-center text-sm text-gray-500"></div>
  </section>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 text-center text-sm text-gray-600 py-6 mt-10">
    &copy; 2025 MyAutoSound. All rights reserved.
  </footer>

  <!-- ================== Loader from tutorials.json + Lite YouTube + Load More + Favorites ================== -->
  <script>
  (async () => {
    const JSON_PATH = 'tutorials.json'; // ou 'data/tutorials.json'
    const STEP = 6; // pagination par section
    const FAV_KEY = 'mas_favs_v1';

    // Containers
    const containers = {
      vfix: document.getElementById('videoFix'),
      vins: document.getElementById('videoInspect'),
      vmaint: document.getElementById('videoMaintenance'),
      audio: document.getElementById('audioSection'),
      pdf: document.getElementById('pdfSection'),
      favs: document.getElementById('favoritesSection')
    };
    const moreBtns = {
      vfix: document.getElementById('more-vfix'),
      vins: document.getElementById('more-vins'),
      vmaint: document.getElementById('more-vmaint'),
      audio: document.getElementById('more-audio'),
      pdf: document.getElementById('more-pdf'),
    };
    const favWrap = document.getElementById('favoritesWrap');
    const favCount = document.getElementById('favCount');
    const clearFavsBtn = document.getElementById('clearFavs');

    const statusMsg = document.getElementById('statusMsg');

    // Filters
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const typeFilter = document.getElementById('typeFilter');

    // Consent
    const hasConsent = localStorage.getItem("cookieConsent") === "accepted";

    // Helpers
    const fallbackThumb = 'assets/img/default-sound.jpg';
    const imgHTML = (src, alt) => {
      return `<img src="${src || fallbackThumb}" alt="${alt}" class="rounded-xl mb-4 w-full h-40 object-cover" loading="lazy" />`;
    };
    const ytThumb = (ytId) => `https://i.ytimg.com/vi/${ytId}/hqdefault.jpg`;

    // Favorites storage
    const loadFavs = () => {
      try { return new Set(JSON.parse(localStorage.getItem(FAV_KEY) || '[]')); }
      catch { return new Set(); }
    };
    const saveFavs = (set) => {
      try { localStorage.setItem(FAV_KEY, JSON.stringify([...set])); } catch {}
    };
    let FAVS = loadFavs();

    // Items data
    let items = [];
    const itemsById = new Map();

    // Star UI updater
    function updateStarUI(id) {
      const active = FAVS.has(id);
      document.querySelectorAll(`.tutorial[data-id="${id}"] .fav-btn`).forEach(btn => {
        btn.textContent = active ? '‚òÖ' : '‚òÜ';
        btn.classList.toggle('text-yellow-500', active);
        btn.classList.toggle('text-gray-300', !active);
        btn.setAttribute('aria-pressed', String(active));
        btn.title = active ? 'Remove from favorites' : 'Add to favorites';
        btn.setAttribute('aria-label', btn.title);
      });
      updateFavWrapVisibility();
    }

    function toggleFav(id) {
      if (FAVS.has(id)) FAVS.delete(id);
      else FAVS.add(id);
      saveFavs(FAVS);
      updateStarUI(id);
      renderFavorites(); // rebuild the favorites section
    }

    function attachFavButton(card, item) {
      card.classList.add('relative');
      const btn = document.createElement('button');
      btn.className = 'fav-btn absolute top-2 right-2 text-xl text-gray-300';
      btn.type = 'button';
      btn.setAttribute('aria-pressed', 'false');
      btn.title = 'Add to favorites';
      btn.setAttribute('aria-label', 'Add to favorites');
      btn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); toggleFav(item.id); });
      card.appendChild(btn);
      updateStarUI(item.id);
    }

    // Build cards
    function createVideoCard(item) {
      const card = document.createElement('div');
      card.className = 'tutorial bg-white rounded-2xl shadow p-4 flex flex-col';
      card.dataset.id = item.id;
      card.dataset.type = 'video';
      card.dataset.category = item.category || '';
      card.dataset.vgroup = (item.vgroup || 'inspect').toLowerCase();
      card.dataset.section = (item.vgroup === 'fix') ? 'vfix' : (item.vgroup === 'maintenance') ? 'vmaint' : 'vins';
      card._title = item.title.toLowerCase();

      const titleHTML = `<h2 class="text-lg font-bold text-blue-700 mb-1">${item.title}</h2>`;
      const descHTML = `<p class="text-sm text-gray-600 mb-3">${item.description || ''}</p>`;

      if (item.ytId) {
        const thumbUrl = item.thumb || ytThumb(item.ytId);
        const wrapper = document.createElement('div');
        wrapper.className = 'yt-lite mb-4';
        wrapper.style.backgroundImage = `url('${thumbUrl}')`;
        wrapper.setAttribute('aria-label', `Play ${item.title}`);
        wrapper.addEventListener('click', () => {
          if (!hasConsent) {
            window.open(`https://www.youtube.com/watch?v=${item.ytId}`, '_blank', 'noopener');
            return;
          }
          const iframe = document.createElement('iframe');
          iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
          iframe.src = `https://www.youtube-nocookie.com/embed/${item.ytId}?autoplay=1&rel=0`;
          iframe.loading = "lazy";
          iframe.title = item.title;
          iframe.width = "100%";
          iframe.height = "315";
          iframe.style.border = "0";
          wrapper.replaceWith(iframe);
        });

        const top = document.createElement('div');
        top.innerHTML = imgHTML(thumbUrl, item.title);
        top.firstElementChild.replaceWith(wrapper);

        const btnHTML = `
          <a href="https://www.youtube.com/watch?v=${item.ytId}" target="_blank" rel="noopener"
             class="bg-red-600 text-white px-4 py-2 rounded text-sm w-fit hover:bg-red-700 transition">‚ñ∂Ô∏è Watch on YouTube</a>`;

        const inner = document.createElement('div');
        inner.innerHTML = `${titleHTML}${descHTML}`;
        card.appendChild(top);
        card.appendChild(inner);
        card.insertAdjacentHTML('beforeend', btnHTML);
      } else {
        const thumbUrl = item.thumb || fallbackThumb;
        const videoUrl = item.videoUrl || '#';
        const btnHTML = `
          <a href="${videoUrl}" target="_blank" rel="noopener"
             class="bg-blue-600 text-white px-4 py-2 rounded text-sm w-fit hover:bg-blue-700 transition">üé• Watch Video</a>`;
        card.innerHTML = `
          ${imgHTML(thumbUrl, item.title)}
          ${titleHTML}
          ${descHTML}
          ${btnHTML}
        `;
      }

      attachFavButton(card, item);
      return card;
    }

    function createAudioCard(item) {
      const card = document.createElement('div');
      card.className = 'tutorial bg-white rounded-2xl shadow p-4 flex flex-col';
      card.dataset.id = item.id;
      card.dataset.type = 'audio';
      card.dataset.category = item.category || '';
      card.dataset.section = 'audio';
      card._title = item.title.toLowerCase();
      card.innerHTML = `
        ${imgHTML(item.thumb, item.title)}
        <div class="flex-1">
          <h2 class="text-lg font-bold text-blue-700 mb-1">${item.title}</h2>
          <p class="text-sm text-gray-600 mb-3">${item.description || ''}</p>
          <audio controls class="w-full"><source src="${item.audioUrl}" type="audio/mpeg" /></audio>
        </div>
      `;
      attachFavButton(card, item);
      return card;
    }

    function createPdfCard(item) {
      const card = document.createElement('div');
      card.className = 'tutorial bg-white rounded-2xl shadow p-4 flex flex-col';
      card.dataset.id = item.id;
      card.dataset.type = 'pdf';
      card.dataset.category = item.category || '';
      card.dataset.section = 'pdf';
      card._title = item.title.toLowerCase();
      card.innerHTML = `
        ${imgHTML(item.thumb, item.title)}
        <div class="flex-1">
          <h2 class="text-lg font-bold text-blue-700 mb-1">${item.title}</h2>
          <p class="text-sm text-gray-600 mb-3">${item.description || ''}</p>
          <a href="${item.pdfUrl}" target="_blank"
             class="bg-gray-700 text-white px-4 py-2 rounded text-sm w-fit hover:bg-gray-800 transition">üìÑ View PDF</a>
        </div>
      `;
      attachFavButton(card, item);
      return card;
    }

    // Load JSON and build cards
    let allCards = [];
    const sections = { vfix: [], vins: [], vmaint: [], audio: [], pdf: [] };
    const limits = { vfix: STEP, vins: STEP, vmaint: STEP, audio: STEP, pdf: STEP };

    try {
      statusMsg.textContent = 'Loading tutorials...';
      const res = await fetch(JSON_PATH, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load JSON');
      items = await res.json();
      items.forEach(it => itemsById.set(it.id, it));

      items.forEach(item => {
        let card;
        if (item.type === 'video') {
          card = createVideoCard(item);
          const key = (item.vgroup === 'fix') ? 'vfix' : (item.vgroup === 'maintenance') ? 'vmaint' : 'vins';
          sections[key].push(card);
          containers[key].appendChild(card);
        } else if (item.type === 'audio') {
          card = createAudioCard(item);
          sections.audio.push(card);
          containers.audio.appendChild(card);
        } else if (item.type === 'pdf') {
          card = createPdfCard(item);
          sections.pdf.push(card);
          containers.pdf.appendChild(card);
        }
        if (card) allCards.push(card);
      });

      statusMsg.textContent = '';
    } catch (err) {
      console.error(err);
      statusMsg.className = 'mt-8 text-center text-sm text-red-600';
      statusMsg.textContent = 'Error loading tutorials. Make sure tutorials.json is accessible (serve over http://, not file://).';
      return;
    }

    // Filtering + pagination
    function matchesFilters(card) {
      const q = (searchInput?.value || '').toLowerCase();
      const cat = categoryFilter?.value || '';
      const typ = typeFilter?.value || '';
      const title = card._title || (card.querySelector('h2')?.textContent || '').toLowerCase();

      const okSearch = !q || title.includes(q);
      const okCat = !cat || (card.dataset.category === cat);
      const okType = !typ || (card.dataset.type === typ);
      return okSearch && okCat && okType;
    }

    function renderSection(key) {
      const cards = sections[key];
      let shown = 0;
      let totalMatched = 0;

      cards.forEach(card => {
        const isMatch = matchesFilters(card);
        if (!isMatch) { card.style.display = 'none'; return; }
        totalMatched++;
        if (shown < limits[key]) { card.style.display = 'block'; shown++; }
        else { card.style.display = 'none'; }
      });

      const btn = moreBtns[key];
      if (!btn) return;
      btn.style.display = (totalMatched > shown) ? 'inline-block' : 'none';
    }

    function renderAll() {
      renderSection('vfix');
      renderSection('vins');
      renderSection('vmaint');
      renderSection('audio');
      renderSection('pdf');
      renderFavorites();
    }

    // Favorites rendering
    function updateFavWrapVisibility() {
      const q = (searchInput?.value || '').toLowerCase();
      const cat = categoryFilter?.value || '';
      const typ = typeFilter?.value || '';
      // Count favorites that match current filters
      let matched = 0;
      FAVS.forEach(id => {
        const item = itemsById.get(id);
        if (!item) return;
        const fakeCard = {
          _title: (item.title || '').toLowerCase(),
          dataset: { category: item.category || '', type: item.type || '' }
        };
        if (( !q || fakeCard._title.includes(q) ) &&
            ( !cat || fakeCard.dataset.category === cat ) &&
            ( !typ || fakeCard.dataset.type === typ )) matched++;
      });

      favCount.textContent = matched ? `(${matched})` : '';
      favWrap.style.display = matched ? 'block' : 'none';
    }

    function createCardForItem(item) {
      if (item.type === 'video') return createVideoCard(item);
      if (item.type === 'audio') return createAudioCard(item);
      return createPdfCard(item);
    }

    function renderFavorites() {
      const wrap = containers.favs;
      wrap.innerHTML = '';
      const q = (searchInput?.value || '').toLowerCase();
      const cat = categoryFilter?.value || '';
      const typ = typeFilter?.value || '';

      FAVS.forEach(id => {
        const item = itemsById.get(id);
        if (!item) return;
        const title = (item.title || '').toLowerCase();
        const okSearch = !q || title.includes(q);
        const okCat = !cat || (item.category === cat);
        const okType = !typ || (item.type === typ);
        if (!(okSearch && okCat && okType)) return;

        const card = createCardForItem(item);
        // Marquer cette carte comme appartenant aux favoris
        card.dataset.section = 'favs';
        wrap.appendChild(card);
      });

      updateFavWrapVisibility();
    }

    // Initial render
    renderAll();

    // Filter hooks
    function resetLimits() {
      limits.vfix = STEP; limits.vins = STEP; limits.vmaint = STEP;
      limits.audio = STEP; limits.pdf = STEP;
    }
    function onFilterChange() {
      resetLimits();
      renderAll();
    }
    searchInput?.addEventListener('input', onFilterChange);
    categoryFilter?.addEventListener('change', onFilterChange);
    typeFilter?.addEventListener('change', onFilterChange);

    // Load more handlers
    moreBtns.vfix?.addEventListener('click', () => { limits.vfix += STEP; renderSection('vfix'); });
    moreBtns.vins?.addEventListener('click', () => { limits.vins += STEP; renderSection('vins'); });
    moreBtns.vmaint?.addEventListener('click', () => { limits.vmaint += STEP; renderSection('vmaint'); });
    moreBtns.audio?.addEventListener('click', () => { limits.audio += STEP; renderSection('audio'); });
    moreBtns.pdf?.addEventListener('click', () => { limits.pdf += STEP; renderSection('pdf'); });

    // Clear all favorites
    clearFavsBtn?.addEventListener('click', () => {
      if (!FAVS.size) return;
      const prev = new Set(FAVS);
      FAVS.clear();
      saveFavs(FAVS);
      // update stars on all ids that were favorited
      prev.forEach(id => updateStarUI(id));
      renderFavorites();
    });
  })();
  </script>
</body>
</html>
